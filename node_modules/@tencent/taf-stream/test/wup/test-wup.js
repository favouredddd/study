/**
 * Created by zhangmindelaogong on 2017/9/10.
 */
var Taf    = require("../../libjce.js");
var Ext = require("../ExtJce.js").Ext;

//TODO: wup编解码中string和int64的bRaw和bString暂未支持
describe("test String", function(){

    it("#test for wup attrbuites", function (){
        var wup_encode = new Taf.Wup();
        wup_encode.should.have.property("servantName");
        wup_encode.should.have.property("funcName");
        wup_encode.should.have.property("requestId");
        wup_encode.should.have.property("wupVersion");

        wup_encode.servantName = "servantName";
        wup_encode.funcName = "funcName";
        wup_encode.requestId = "requestId";
        wup_encode.wupVersion = "wupVersion";

        wup_encode.servantName.should.equal("servantName");
        wup_encode.funcName.should.equal("funcName");
        wup_encode.requestId.should.equal("requestId");
        wup_encode.wupVersion.should.equal("wupVersion");

        wup_encode._status.insert("STATUS_RESULT_CODE","8888");
        wup_encode._status.insert("STATUS_RESULT_DESC","test desc");
        wup_encode.getTafResultCode().should.equal(8888);
        wup_encode.getTafResultDesc().should.equal("test desc");

    });

   it(" test encode and decode", function(){
       var valueMap = {
           bool: true,
           int8: 88,
           uint8: 200,
           int16: 20000,
           uint16: 60000,
           int32: 2147483647,
           uint32: 4294967295,
           int64: 9007199254740991,
           float: Math.pow(2,-127),
           double: Math.pow(2,1023),
           bytes:  new Taf.BinBuffer(Buffer.from("abc")),
           string: "test wup",
           list: new Taf.List(Taf.String),
           map: new Taf.Map(Taf.String, Taf.String),
           struct:new Ext.ExtInfo()
       }
       valueMap.list.readFromObject(["test", "wup"]);
       valueMap.map.readFromObject({"key": "value"});
       valueMap.struct.data.insert("key", valueMap.bytes);


       var wup_encode = new Taf.Wup();
       wup_encode.writeBoolean("bool", valueMap.bool);
       wup_encode.writeInt8("int8", valueMap.int8);
       wup_encode.writeUInt8("uint8", valueMap.uint8);
       wup_encode.writeInt16("int16", valueMap.int16);
       wup_encode.writeUInt16("uint16", valueMap.uint16);
       wup_encode.writeInt32("int32", valueMap.int32);
       wup_encode.writeUInt32("uint32", valueMap.uint32);
       wup_encode.writeInt64("int64", valueMap.int64);
       wup_encode.writeFloat("float", valueMap.float);
       wup_encode.writeDouble("double", valueMap.double);
       wup_encode.writeBytes("bytes", valueMap.bytes);
       wup_encode.writeString("string", valueMap.string);
       wup_encode.writeStruct("struct", valueMap.struct);
       wup_encode.writeList("list", valueMap.list);
       wup_encode.writeMap("map", valueMap.map);


       var BinBuffer = wup_encode.encode();
       var data = BinBuffer.toNodeBuffer();

       var wup_decode = new Taf.Wup();
       wup_decode.decode(new Taf.BinBuffer(data));
       wup_decode.readBoolean("bool").should.equal(valueMap.bool)
       wup_decode.readInt8("int8").should.equal(valueMap.int8)
       wup_decode.readUInt8("uint8").should.equal(valueMap.uint8)
       wup_decode.readInt16("int16").should.equal(valueMap.int16)
       wup_decode.readUInt16("uint16").should.equal(valueMap.uint16)
       wup_decode.readInt32("int32").should.equal(valueMap.int32)
       wup_decode.readUInt32("uint32").should.equal(valueMap.uint32)
       wup_decode.readInt64("int64").should.equal(valueMap.int64)
       wup_decode.readFloat("float").should.equal(valueMap.float)
       wup_decode.readDouble("double").should.equal(valueMap.double)
       wup_decode.readBytes("bytes").toString().should.equal(valueMap.bytes.toString())
       wup_decode.readString("string").should.equal(valueMap.string)
       var struct = wup_decode.readStruct("struct", Ext.ExtInfo);
       struct.data.get("key").toNodeBuffer().toString().should.equal("abc");
       var list = wup_decode.readList("list",Taf.List(Taf.String));
       JSON.stringify(list.toObject()).should.equal(JSON.stringify(valueMap.list.toObject()));
       var map = wup_decode.readMap("map", Taf.Map(Taf.String, Taf.String));
       JSON.stringify(map.toObject()).should.equal(JSON.stringify(valueMap.map.toObject()));
   })

    it("test string to raw", function(){
        var wup_encode = new Taf.Wup();
        wup_encode.writeString("string", Buffer.from("test wup"), true);

        var BinBuffer = wup_encode.encode();
        var data = BinBuffer.toNodeBuffer();

        var wup_decode = new Taf.Wup();
        wup_decode.decode(new Taf.BinBuffer(data));
        var decodeStr = wup_decode.readString("string",Buffer.from(""), true);
        (decodeStr instanceof Buffer).should.be.true();
        decodeStr.should.not.be.a.String();
        decodeStr.toString().should.equal("test wup");
    })

    it("test long to string", function(){

        testWupLong("-9223372036854775808");
        testWupLong("-9223372036854775802");
        testWupLong("9223372036854775807");
        testWupLong("9223372036854775801");

        function testWupLong(value){
            var wup_encode = new Taf.Wup();
            wup_encode.writeInt64("int64", value, true);

            var BinBuffer = wup_encode.encode();
            var data = BinBuffer.toNodeBuffer();

            var wup_decode = new Taf.Wup();
            wup_decode.decode(new Taf.BinBuffer(data));
            var decodeInt64 = wup_decode.readInt64("int64","0", true);
            decodeInt64.should.be.a.String();
            decodeInt64.should.equal(value);
        }
    })

    it("test long in map", function(){
        testLongInMapKey("-9223372036854775808","test");
        testLongInMapKey("-9223372036854775802","test");
        testLongInMapKey("9223372036854775807","test");
        testLongInMapKey("9223372036854775801","test");

        testLongInMapValue("test", "-9223372036854775808");
        testLongInMapValue("test", "-9223372036854775802");
        testLongInMapValue("test", "9223372036854775807");
        testLongInMapValue("test", "9223372036854775801");

        function testLongInMapValue(key, value){
            var wup_encode = new Taf.Wup();
            var mapValue = new Taf.Map(Taf.String, Taf.Int64 ,0 ,1);
            mapValue.insert(key, value);

            wup_encode.writeMap("map", mapValue);

            var BinBuffer = wup_encode.encode();
            var data = BinBuffer.toNodeBuffer();

            var wup_decode = new Taf.Wup();
            wup_decode.decode(new Taf.BinBuffer(data));
            var decodeMap = wup_decode.readMap("map",Taf.Map(Taf.String, Taf.Int64 ,0 ,1));
            decodeMap.has(key).should.be.true();
            decodeMap.get(key).should.be.a.String();
            decodeMap.get(key).should.equal(value);
        }

        function testLongInMapKey(key, value){
            var wup_encode = new Taf.Wup();
            var mapValue = new Taf.Map(Taf.Int64, Taf.String ,1 ,0);
            mapValue.insert(key, value);

            wup_encode.writeMap("map", mapValue);

            var BinBuffer = wup_encode.encode();
            var data = BinBuffer.toNodeBuffer();

            var wup_decode = new Taf.Wup();
            wup_decode.decode(new Taf.BinBuffer(data));
            var decodeMap = wup_decode.readMap("map",Taf.Map(Taf.Int64, Taf.String ,1 ,0));
            decodeMap.has(key).should.be.true();
            decodeMap.get(key).should.be.a.String();
            decodeMap.get(key).should.equal(value);
        }
    })

    it("test long in list", function() {
        testLongInList("-9223372036854775808");
        testLongInList("-9223372036854775802");
        testLongInList("9223372036854775807");
        testLongInList("9223372036854775801");

        function testLongInList(value){
            var wup_encode = new Taf.Wup();
            var listValue = new Taf.List(Taf.Int64, 1);
            listValue.push(value);

            wup_encode.writeList("list", listValue);

            var BinBuffer = wup_encode.encode();
            var data = BinBuffer.toNodeBuffer();

            var wup_decode = new Taf.Wup();
            wup_decode.decode(new Taf.BinBuffer(data));
            var decodeList = wup_decode.readList("list",Taf.List(Taf.Int64,1));
            decodeList.length.should.equal(1);
            decodeList.at(0).should.be.a.String();
            decodeList.at(0).should.equal(value);
        }
    })
})