var http = require("http");
var Taf  = require('../../../../../taf-stream');
var TRom = require("./NodeTafJce.js").TRom;

//组织请求数据
var wup = new Taf.Wup();
wup.wupVersion  = Taf.Wup.WUP_COMPLEX;
wup.servantName = "node.nodetafserver";   //该servantName是在WupProxyServer中注册的名字
wup.funcName    = "getall";               //该funcName是服务端真实的函数名称

var stUser = new TRom.User_t();
stUser.id    = 10000;
stUser.score = 88888;
stUser.name  = "ForWupTest";

wup.writeStruct("stUser", stUser);

//发送请求数据
var binBuffer = wup.encode();
var postData  = binBuffer.toNodeBuffer();

var options = {
    hostname : '127.0.0.1',    //该地址为WupProxyServer的地址
    port     : 14002,               //该端口为WupProxyServer的端口
    path     : '/',
    method   : 'POST',
    headers  : {
        'Content-Type': 'application/octet-stream',
        'Content-Length': postData.length
    }
};

var req = http.request(options, function(res) {
    res.on('data', function (chunk) {
        var data = new Taf.BinBuffer(new Buffer(chunk));
        var wup  = new Taf.Wup();
        wup.decode(data);

        var stResult = wup.readStruct("stResult", TRom.Result_t);
        console.log("result.response.return: ",             wup.readInt32(""));
        console.log("result.response.arguments.stResult:",  stResult.id, stResult.iLevel);
    });
});

req.on('error', function(e) {
    console.log('problem with request: ' + e.message);
});

req.write(postData);
req.end();
