'use strict';

var util = require('util'),
	fs = require('fs'),
	path = require('path');

var strftime = require('strftime'),
	winston = require('winston');

var TafBase = require('../taf-base'),
	TafDateFormat = require('../util/date-format');

var Formatter = require('../../lib/formatter');

var TafDate = exports.TafDate = function (options) {
	var instance = TafBase.call(this, options);

	if (instance) {
		return instance;
	}

	this.options.concatStr = options.concatStr || '_';
	this.options.formatter = options.formatter || Formatter.Simple();
	this.options.format = options.format || TafDateFormat.LogByDay;

	if (typeof this.options.format === 'function') {
		this.options.format = new this.options.format();
	}
};

util.inherits(TafDate, TafBase);

TafDate.prototype.name = 'tafDate';

TafDate.prototype._checkfile = function(cb) {
	var now = new Date, regenerate = true, nowTime;

	if (this.options.format.name !== 'custom') {
		nowTime = parseInt(strftime(this.options.format.timePattern, now));

		if (this._lastTime && nowTime - this._lastTime < this.options.format.interval) {
			regenerate = false;
		} else {
			this._lastTime = nowTime;
		}
	}

	if (regenerate) {
		this.filename = path.join(this._dirname, this._basename + '_' + strftime(this.options.format.logPattern, now) + this._extname);
	}

	fs.stat(this.filename, function(err, stats) {
		if (err && err.code !== 'ENOENT') {
			cb(err);
			return;
		}

		cb();
	});
};

TafDate.FORMAT = TafDateFormat;

winston.transports.TafDate = TafDate;