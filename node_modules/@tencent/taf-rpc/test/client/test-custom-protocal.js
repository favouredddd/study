require("should");
var Protocol    = require("@tencent/taf-rpc-json");
var Communicator = require("../../protal.js").Communicator;
var ServantProxy = require("../../protal.js").ServantProxy;
var TafSvr      = require("../../protal.js").server;

describe("test-custom-protocal", function () {
    var server, communicator;
    before(function(done) {
        var EchoHandle = function () {}
        EchoHandle.prototype.initialize = function () {
            console.log("EchoHandle.prototype.initialize");
        }
        EchoHandle.prototype.echo = function (current, appBuffer) {
            current.sendResponse(appBuffer);
        }
        EchoHandle.prototype.doRequest = function ($current, $originRequest) {
            console.log("EchoHandle.doRequest::", $originRequest, arguments.length);
            current.sendResponse("timestamp:" + current.timestamp, "TX", "TX-MIG");
        }
        var option = new TafSvr.BindAdapterOption();
        option.endpoint     = "tcp -h 127.0.0.1 -p 14004 -t 10000";
        option.protocolName = "json";
        option.protocol     = Protocol.server;
        option.handleImp    = EchoHandle;
        server = TafSvr.createServer();
        server.start(option);

        communicator = Communicator.New();

        setTimeout(function () {
            done()
        },1000)
    })
    after(function() {
        communicator.destroy();
        server.stop();
    })

    it("1. test createFunc", function (done) {
        var prx = communicator.stringToProxy(ServantProxy, "test@tcp -h 127.0.0.1 -p 14004 -t 60000");
        prx.setProtocol(Protocol.client);
        prx.rpc.createFunc("echo");
        prx.rpc.echo("test").then(function () {
            done()
        }).catch(function (err) {
            done(err.response? err.response.error : err);
        });
    })
    it("2. test rpc_call", function (done) {
        var prx = communicator.stringToProxy(ServantProxy, "test@tcp -h 127.0.0.1 -p 14004 -t 60000");
        prx.setProtocol(Protocol.client);
        prx.rpc_call(1, "echo", "test").then(function () {
            done()
        }).catch(function (err) {
            done(err.response? err.response.error : err);
        });
    })
});