'use strict';

var fs = require('fs'),
	path = require('path');

var async = require('async');

exports.rotate = function(dirname, basename, extname, filename, maxFiles, maxSize, concatStr, cb) {
	fs.stat(filename, function(err, stats) {
		if (err) {
			if (err.code !== 'ENOENT') {
				cb && cb(err);
				return;
			}
		}

		if (stats && stats.size > maxSize) {
			fs.unlink(path.join(dirname, basename + '_' + (maxFiles - 1) + extname), function() {
				var i, list = [];
				for (i = maxFiles - 2; i > 0; i -= 1) {
					list.push({
						oldPath : path.join(dirname, basename + concatStr + i + extname),
						newPath : path.join(dirname, basename + concatStr + (i + 1) + extname)
					});
				}

				async.eachSeries(list, function(item, callback) {
					fs.rename(item.oldPath, item.newPath, function() {
						callback();
					});
				}, function() {
					fs.rename(filename, path.join(dirname, basename + concatStr + '1' + extname), function() {
						cb && cb(null, true);
					});
				});
			});
		} else {
			cb && cb(null, false);
		}
	});
};